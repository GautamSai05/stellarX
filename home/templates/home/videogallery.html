{% extends 'base.html' %}
{% load static %}

{% block title %}Video Gallery - StellarSense{% endblock %}

{% block content %}
<main class="container mx-auto p-4 min-h-screen" aria-labelledby="pageTitle">
  <div class="mb-6">
    <h2 id="pageTitle" class="text-4xl font-bold bg-gradient-to-r from-blue-400 to-purple-400 bg-clip-text text-transparent mb-2">Space Video Gallery</h2>
    <p class="text-gray-400">Explore documentaries and mission footage. Use keyboard: Tab to navigate, Enter to open, Esc to close modal.</p>
  </div>

  <div class="mb-6 flex flex-col md:flex-row md:items-center md:space-x-4 space-y-4 md:space-y-0">
    <label for="searchInput" class="sr-only">Search videos</label>
    <div class="relative flex-1">
      <svg class="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400 w-5 h-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-4.35-4.35"></path><circle cx="11" cy="11" r="6" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></circle></svg>
      <input id="searchInput" type="search" inputmode="search" placeholder="Search videos..." aria-label="Search videos" class="w-full pl-10 pr-4 py-3 bg-gray-900/60 border border-white/20 rounded-xl text-white placeholder-gray-400 focus:border-blue-500 focus:outline-none" />
    </div>

    <div class="flex items-center space-x-2">
      <label for="categorySelect" class="sr-only">Filter by category</label>
      <select id="categorySelect" class="px-4 py-3 bg-gray-900/60 border border-white/20 rounded-xl text-white focus:border-blue-500 focus:outline-none">
      </select>
    </div>
  </div>

  <div id="resultCount" class="text-sm text-gray-400 mb-4"></div>

  <section id="videoGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6" aria-live="polite"></section>

  <!-- Modal -->
  <div id="videoModal" class="fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center z-50 p-4 hidden" role="dialog" aria-modal="true" aria-hidden="true">
    <div id="modalContent" class="bg-gray-900/90 backdrop-blur-md rounded-2xl overflow-hidden max-w-6xl w-full max-h-[90vh] border border-white/20">
      <div class="relative aspect-video bg-black" id="modalPlayerWrap">
        <button id="modalCloseBtn" aria-label="Close video" class="absolute top-4 right-4 p-2 bg-black/50 hover:bg-black/70 rounded-lg transition-colors z-10 text-white">âœ•</button>
      </div>
      <div class="p-6">
        <div class="flex items-start justify-between mb-4">
          <div class="flex-1">
            <h2 id="modalTitle" class="text-2xl font-bold text-white mb-2"></h2>
            <div id="modalMeta" class="flex items-center space-x-4 text-gray-400 mb-3"></div>
          </div>
          <span id="modalCategory" class="px-3 py-1 rounded-full text-sm bg-gray-700 text-white">Category</span>
        </div>
        <p id="modalDesc" class="text-gray-300 leading-relaxed"></p>
      </div>
    </div>
  </div>
</main>

<script>
// Data (from user's provided list)
const videos = [
  { id: '1', title: 'Journey to Mars: The Future of Human Space Exploration', description: "Explore NASA's ambitious plans to send humans to Mars, including the technologies and challenges involved in this historic mission.", thumbnail: 'https://i.ytimg.com/vi/21GLi9RJQKc/maxresdefault.jpg', duration: '12:45', views: '2.3M', category: 'Mars Exploration', embedId: '21GLi9RJQKc', uploadDate: '2024-01-15' },
  { id: '2', title: 'The James Webb Space Telescope: Unveiling the Universe', description: 'Discover how the James Webb Space Telescope is revolutionizing our understanding of the cosmos with unprecedented infrared observations.', thumbnail: 'https://i.ytimg.com/vi/OcWEYDddJ7Q/maxresdefault.jpg', duration: '18:30', views: '4.1M', category: 'Space Technology', embedId: 'OcWEYDddJ7Q', uploadDate: '2024-01-12' },
  { id: '3', title: 'Apollo 11: The Greatest Adventure in Human History', description: 'Relive the historic Apollo 11 mission that first landed humans on the Moon, featuring rare footage and interviews.', thumbnail: 'https://i.ytimg.com/vi/raN5VLEro1w/maxresdefault.jpg', duration: '25:15', views: '8.7M', category: 'Historical Missions', embedId: 'raN5VLEro1w', uploadDate: '2024-01-10' },
  { id: '4', title: 'SpaceX Starship: The Vehicle That Will Take Us to Mars', description: "An in-depth look at SpaceX's Starship, the most powerful rocket ever built, designed to carry humans to Mars and beyond.", thumbnail: 'https://i.ytimg.com/vi/eXrHYolBgTQ/hq720.jpg', duration: '15:20', views: '3.5M', category: 'Space Technology', embedId: 'eXrHYolBgTQ', uploadDate: '2024-01-08' },
  { id: '5', title: 'Life on the International Space Station', description: "Experience daily life aboard the ISS with astronauts as they conduct experiments and maintain humanity's outpost in space.", thumbnail: 'https://i.ytimg.com/vi/-Y04Zic1-r4/maxresdefault.jpg', duration: '22:10', views: '1.9M', category: 'Astronaut Life', embedId: '-Y04Zic1-r4', uploadDate: '2024-01-05' },
  { id: '6', title: 'The Search for Extraterrestrial Life', description: 'Join scientists as they search for signs of life beyond Earth, from Mars to the moons of Jupiter and Saturn.', thumbnail: 'https://i.ytimg.com/vi/cl_YuKk9mzg/maxresdefault.jpg', duration: '20:45', views: '2.8M', category: 'Astrobiology', embedId: 'cl_YuKk9mzg', uploadDate: '2024-01-03' },
  { id: '7', title: 'Black Holes: The Most Mysterious Objects in the Universe', description: 'Explore the fascinating world of black holes, from their formation to their role in shaping galaxies.', thumbnail: 'https://i.ytimg.com/vi/pUWMl5W1b_M/hq720.jpg', duration: '16:35', views: '5.2M', category: 'Astrophysics', embedId: 'pUWMl5W1b_M', uploadDate: '2024-01-01' },
  { id: '8', title: 'Women Pioneers in Space Exploration', description: 'Celebrate the achievements of women who broke barriers in space exploration, from Valentina Tereshkova to modern astronauts.', thumbnail: 'https://i.ytimg.com/vi/FDxm8DPZFcE/hq720.jpg', duration: '19:25', views: '1.6M', category: 'Historical Missions', embedId: 'FDxm8DPZFcE', uploadDate: '2023-12-28' }
];

const categories = ['all', 'Mars Exploration', 'Space Technology', 'Historical Missions', 'Astronaut Life', 'Astrobiology', 'Astrophysics'];

// Elements
const categorySelect = document.getElementById('categorySelect');
const searchInput = document.getElementById('searchInput');
const videoGrid = document.getElementById('videoGrid');
const videoModal = document.getElementById('videoModal');
const modalPlayerWrap = document.getElementById('modalPlayerWrap');
const modalTitle = document.getElementById('modalTitle');
const modalDesc = document.getElementById('modalDesc');
const modalMeta = document.getElementById('modalMeta');
const modalCategory = document.getElementById('modalCategory');
const modalCloseBtn = document.getElementById('modalCloseBtn');
const resultCount = document.getElementById('resultCount');

let selectedCategory = 'all';
let selectedVideo = null;
let searchTerm = '';

function getCategoryColor(category) {
  switch (category) {
    case 'Mars Exploration': return 'bg-red-600/20 text-red-300';
    case 'Space Technology': return 'bg-blue-600/20 text-blue-300';
    case 'Historical Missions': return 'bg-purple-600/20 text-purple-300';
    case 'Astronaut Life': return 'bg-green-600/20 text-green-300';
    case 'Astrobiology': return 'bg-yellow-600/20 text-yellow-300';
    case 'Astrophysics': return 'bg-indigo-600/20 text-indigo-300';
    default: return 'bg-gray-600/20 text-gray-300';
  }
}

function renderCategories() {
  categorySelect.innerHTML = '';
  categories.forEach(cat => {
    const opt = document.createElement('option');
    opt.value = cat;
    opt.textContent = cat === 'all' ? 'All Categories' : cat;
    categorySelect.appendChild(opt);
  });
}

function filterVideos() {
  const filtered = videos.filter(video => {
    const matchesCategory = selectedCategory === 'all' || video.category === selectedCategory;
    const matchesSearch = video.title.toLowerCase().includes(searchTerm.toLowerCase()) || video.description.toLowerCase().includes(searchTerm.toLowerCase());
    return matchesCategory && matchesSearch;
  });
  return filtered;
}

function renderGrid() {
  videoGrid.innerHTML = '';
  const filtered = filterVideos();
  resultCount.textContent = `${filtered.length} videos`;

  if (filtered.length === 0) {
    const empty = document.createElement('div');
    empty.className = 'text-center py-12 col-span-full';
    empty.innerHTML = `\n      <div class=\"text-6xl mb-4\">ðŸŽ¬</div>\n      <h3 class=\"text-xl font-semibold text-white mb-2\">No videos found</h3>\n      <p class=\"text-gray-400\">Try adjusting your search terms or category filter</p>\n    `;
    videoGrid.appendChild(empty);
    return;
  }

  filtered.forEach(video => {
    const card = document.createElement('button');
    card.type = 'button';
    card.className = 'text-left bg-gray-900/60 backdrop-blur-md rounded-2xl overflow-hidden border border-white/10 hover:border-blue-500/50 transition-all cursor-pointer group focus:outline-none focus:ring-2 focus:ring-blue-500';
    card.addEventListener('click', () => openModal(video));

    const rel = document.createElement('div');
    rel.className = 'relative';

    const img = document.createElement('img');
    img.src = video.thumbnail;
    img.alt = video.title;
    img.className = 'w-full h-48 object-cover group-hover:scale-105 transition-transform duration-300';

    const overlay = document.createElement('div');
    overlay.className = 'absolute inset-0 bg-black/40 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity';
    overlay.innerHTML = `<div class=\"w-16 h-16 bg-blue-600/80 rounded-full flex items-center justify-center\"><svg class=\"w-6 h-6 text-white ml-1\" xmlns=\"http://www.w3.org/2000/svg\" fill=\"none\" viewBox=\"0 0 24 24\" stroke=\"currentColor\"><path stroke-linecap=\"round\" stroke-linejoin=\"round\" stroke-width=\"2\" d=\"M14.752 11.168l-5.197-3.023A1 1 0 008 9.03v5.94a1 1 0 001.555.832l5.197-3.023a1 1 0 000-1.664z\"/></svg></div>`;

    const durationBadge = document.createElement('div');
    durationBadge.className = 'absolute bottom-2 right-2 bg-black/80 px-2 py-1 rounded text-white text-sm';
    durationBadge.textContent = video.duration;

    const categoryBadgeWrap = document.createElement('div');
    categoryBadgeWrap.className = 'absolute top-2 left-2';
    const categoryBadge = document.createElement('span');
    const catClasses = getCategoryColor(video.category);
    categoryBadge.className = `px-2 py-1 rounded-full text-xs ${catClasses}`;
    categoryBadge.textContent = video.category;
    categoryBadgeWrap.appendChild(categoryBadge);

    rel.appendChild(img);
    rel.appendChild(overlay);
    rel.appendChild(durationBadge);
    rel.appendChild(categoryBadgeWrap);

    const body = document.createElement('div');
    body.className = 'p-4';

    const h3 = document.createElement('h3');
    h3.className = 'text-lg font-semibold text-white mb-2 line-clamp-2';
    h3.textContent = video.title;

    const p = document.createElement('p');
    p.className = 'text-gray-400 text-sm line-clamp-2 mb-3';
    p.textContent = video.description;

    const meta = document.createElement('div');
    meta.className = 'flex items-center justify-between text-sm text-gray-500';
    meta.innerHTML = `<div class=\"flex items-center space-x-1\"><svg class=\"w-4 h-4\" xmlns=\"http://www.w3.org/2000/svg\" fill=\"none\" viewBox=\"0 0 24 24\" stroke=\"currentColor\"><path stroke-linecap=\"round\" stroke-linejoin=\"round\" stroke-width=\"2\" d=\"M15 10l4.553-2.276A2 2 0 0122 9.618v4.764a2 2 0 01-2.447 1.894L15 14M4 6v12m0 0l4-4m-4 4l4-4\"/></svg><span>${video.views} views</span></div><div class=\"flex items-center space-x-1\"><svg class=\"w-4 h-4\" xmlns=\"http://www.w3.org/2000/svg\" fill=\"none\" viewBox=\"0 0 24 24\" stroke=\"currentColor\"><path stroke-linecap=\"round\" stroke-linejoin=\"round\" stroke-width=\"2\" d=\"M8 7V3m8 4V3M3 11h18M5 21h14a2 2 0 002-2V7H3v12a2 2 0 002 2z\"/></svg><span>${new Date(video.uploadDate).toLocaleDateString()}</span></div>`;

    body.appendChild(h3);
    body.appendChild(p);
    body.appendChild(meta);

    card.appendChild(rel);
    card.appendChild(body);

    videoGrid.appendChild(card);
  });
}

function openModal(video) {
  selectedVideo = video;
  modalTitle.textContent = video.title;
  modalDesc.textContent = video.description;
  modalMeta.innerHTML = `<div class=\"flex items-center space-x-1\"><svg class=\"w-4 h-4\" xmlns=\"http://www.w3.org/2000/svg\" fill=\"none\" viewBox=\"0 0 24 24\" stroke=\"currentColor\"><path stroke-linecap=\"round\" stroke-linejoin=\"round\" stroke-width=\"2\" d=\"M15 10l4.553-2.276A2 2 0 0122 9.618v4.764a2 2 0 01-2.447 1.894L15 14M4 6v12m0 0l4-4m-4 4l4-4\"/></svg><span>${video.views} views</span></div><div class=\"flex items-center space-x-1\"><svg class=\"w-4 h-4\" xmlns=\"http://www.w3.org/2000/svg\" fill=\"none\" viewBox=\"0 0 24 24\" stroke=\"currentColor\"><path stroke-linecap=\"round\" stroke-linejoin=\"round\" stroke-width=\"2\" d=\"M8 7V3m8 4V3M3 11h18M5 21h14a2 2 0 002-2V7H3v12a2 2 0 002 2z\"/></svg><span>${video.duration}</span></div><span>${new Date(video.uploadDate).toLocaleDateString()}</span>`;
  modalCategory.textContent = video.category;
  modalCategory.className = `px-3 py-1 rounded-full text-sm ${getCategoryColor(video.category)}`;

  // build embed src using youtube-nocookie and include origin parameter
  try {
    const origin = window.location && window.location.origin ? window.location.origin : '';
    const embedSrc = `https://www.youtube-nocookie.com/embed/${video.embedId}?rel=0&modestbranding=1&autoplay=1&origin=${encodeURIComponent(origin)}`;

    modalPlayerWrap.innerHTML = `<iframe src=\"${embedSrc}\" title=\"${video.title}\" class=\"w-full h-full\" allow=\"accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share\" allowfullscreen></iframe>`;

    // detect iframe load failure (embedding blocked) â€” if no load after timeout, show fallback
    const iframe = modalPlayerWrap.querySelector('iframe');
    let loaded = false;
    const onLoad = () => { loaded = true; iframe.removeEventListener('load', onLoad); clearTimeout(loadTimeout); };
    if (iframe) {
      iframe.addEventListener('load', onLoad);
      const loadTimeout = setTimeout(() => {
        if (!loaded) {
          // replace iframe with fallback message/link
          modalPlayerWrap.innerHTML = `<div class=\"w-full h-full flex flex-col items-center justify-center text-gray-300 p-4\">Embedding blocked or unavailable. <a href=\"https://www.youtube.com/watch?v=${video.embedId}\" target=\"_blank\" rel=\"noopener noreferrer\" class=\"text-blue-400 underline mt-2\">Open on YouTube</a></div>`;
        }
      }, 1600); // ~1.6s timeout
    }

    // Add a clear fallback link to open the video on YouTube if embedding is blocked by the owner or policy
    const watchUrl = `https://www.youtube.com/watch?v=${video.embedId}`;
    const watchLink = document.createElement('a');
    watchLink.href = watchUrl;
    watchLink.target = '_blank';
    watchLink.rel = 'noopener noreferrer';
    watchLink.className = 'ml-3 inline-block text-sm text-blue-400 hover:underline';
    watchLink.textContent = 'Watch on YouTube';
    // insert or replace any existing watch link
    // ensure modalMeta exists and append the link
    if (modalMeta) {
      // remove previous fallback links if present
      const prev = modalMeta.querySelector('.videogallery-watch-link');
      if (prev) prev.remove();
      watchLink.classList.add('videogallery-watch-link');
      modalMeta.appendChild(watchLink);
    }

  } catch (err) {
    // If constructing the iframe fails for any reason, show the direct link instead
    modalPlayerWrap.innerHTML = `<div class=\"w-full h-full flex items-center justify-center text-gray-300\">Embedded player unavailable. <a href=\"https://www.youtube.com/watch?v=${video.embedId}\" target=\"_blank\" rel=\"noopener noreferrer\" class=\"text-blue-400 underline ml-2\">Open on YouTube</a></div>`;
  }

  videoModal.classList.remove('hidden');
  videoModal.setAttribute('aria-hidden', 'false');
  // focus trap start: focus close button
  modalCloseBtn.focus();
}

function closeModal() {
  selectedVideo = null;
  modalPlayerWrap.innerHTML = '';
  videoModal.classList.add('hidden');
  videoModal.setAttribute('aria-hidden', 'true');
  // return focus to search input
  searchInput.focus();
}

// debounce helper
function debounce(fn, wait) {
  let t;
  return (...args) => { clearTimeout(t); t = setTimeout(() => fn.apply(this, args), wait); };
}

categorySelect.addEventListener('change', (e) => {
  selectedCategory = e.target.value;
  renderGrid();
});

searchInput.addEventListener('input', debounce((e) => {
  searchTerm = e.target.value;
  renderGrid();
}, 200));

modalCloseBtn.addEventListener('click', closeModal);
videoModal.addEventListener('click', (e) => { if (e.target === videoModal) closeModal(); });

// allow ESC to close modal
document.addEventListener('keydown', (e) => {
  if (e.key === 'Escape' && videoModal && !videoModal.classList.contains('hidden')) {
    closeModal();
  }
});

// initialize
renderCategories();
renderGrid();
</script>

{% endblock %}
