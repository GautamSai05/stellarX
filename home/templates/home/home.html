{% extends 'base.html' %}

{% block title %}Home - StellarSense{% endblock %}

{% block content %}
<div class="grid grid-cols-1 lg:grid-cols-3 gap-8">

    <!-- Main Content -->
    <div class="lg:col-span-2 space-y-8">
        <div>
            <h1 class="text-4xl font-bold mb-3">üåå Welcome to StellarSense</h1>
            <p class="text-lg text-gray-300">
                Explore daily celestial wonders and recent sky logs from fellow stargazers.
            </p>
        </div>

        {% if user.is_authenticated %}
        <div>
            <a href="{% url 'log_create' %}" class="inline-block bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-lg transition duration-300">
                ‚ûï Create New Log
            </a>
        </div>
        {% endif %}

        <!-- NASA APOD -->
        <div class="bg-gray-800 rounded-lg shadow-lg p-6">
            <h2 class="text-2xl font-semibold mb-4">üî≠ NASA Astronomy Picture of the Day</h2>
            {% if apod.url %}
                <h3 class="text-xl font-medium mb-2">{{ apod.title }}</h3>
                <img src="{{ apod.url }}" alt="NASA APOD" class="rounded-lg max-h-96 w-full object-cover mb-3">
                <p class="text-gray-300 text-sm">{{ apod.explanation }}</p>
            {% else %}
                <p class="text-gray-400">NASA APOD data not available right now.</p>
            {% endif %}
        </div>

        <!-- Logs -->
        <div class="bg-gray-800 rounded-lg shadow-lg p-6">
            <h2 class="text-2xl font-semibold mb-4">üìù Recent Celestial Logs</h2>
            {% if logs %}
                <div class="space-y-6">
                    {% for log in logs %}
                        <div class="bg-gray-700 p-4 rounded-lg shadow-md">
                            <h4 class="text-lg font-bold">{{ log.title }}</h4>
                            <p class="text-gray-300 mb-2">{{ log.description|truncatewords:30 }}</p>
                            {% if log.photo %}
                                <img src="{{ log.photo.url }}" alt="Observation Photo" class="rounded-lg max-h-72 w-full object-cover mb-2">
                            {% endif %}
                            <p class="text-sm text-gray-400">
                                Logged by <span class="text-blue-300">{{ log.user.username }}</span> on {{ log.created_at }}
                            </p>
                        </div>
                    {% endfor %}
                </div>
            {% else %}
                <p class="text-gray-400">
                    No logs yet. <a href="{% url 'log_create' %}" class="text-blue-400 underline">Be the first to add one!</a>
                </p>
            {% endif %}
        </div>
    </div>

    <!-- Empty Sidebar -->
    <div></div>
</div>

<!-- Fixed Chat Section -->
<div class="fixed bottom-4 right-4 w-[25rem] max-w-full sm:max-w-[90%] max-h-[70vh] bg-gray-800 rounded-lg shadow-lg p-4 z-50 flex flex-col">
    <h3 class="text-lg font-semibold text-white mb-2">üí¨ Live Comments</h3>

    <div id="live-comments" class="flex-1 overflow-y-auto space-y-2 pr-1">
        <!-- Messages will appear here -->
    </div>

    <!-- Chat Input -->
    <form id="chat-form" class="mt-4 flex">
        <input type="text" id="chat-message-input" placeholder="Type a message..."
            class="flex-1 px-3 py-2 rounded-l bg-gray-700 text-white border border-gray-600 focus:outline-none break-words"
            autocomplete="off">
        <button type="submit"
            class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-r">Send</button>
    </form>
</div>

<script>
    const commentBox = document.getElementById('live-comments');
    const chatInput = document.getElementById('chat-message-input');
    const chatForm = document.getElementById('chat-form');

    const socket = new WebSocket('ws://' + window.location.host + '/ws/comments/');

    socket.onmessage = function (e) {
        const data = JSON.parse(e.data);
        if (data.message && data.username) {
            const comment = document.createElement('div');
            comment.innerHTML = `<strong class="text-blue-400">${data.username}</strong>: <span class="break-words">${data.message}</span>`;
            comment.className = "bg-blue-900 text-white p-2 rounded shadow-md whitespace-pre-wrap break-words";
            commentBox.appendChild(comment);
            commentBox.scrollTop = commentBox.scrollHeight;
        }
    };

    chatForm.addEventListener('submit', function (e) {
        e.preventDefault();
        const message = chatInput.value.trim();
        if (message) {
            socket.send(JSON.stringify({ message: message }));
            chatInput.value = '';
        }
    });
</script>
{% endblock %}
