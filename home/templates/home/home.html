{% extends 'base.html' %}

{% block title %}Home - StellarSense{% endblock %}

{% block content %}
<div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
    <!-- Main Content -->
    <div class="lg:col-span-2 space-y-8">
        <div>
            <h1 class="text-5xl font-extrabold mb-4 text-blue-400 animate-pulse">üåå Welcome to StellarSense</h1>
            <p class="text-xl text-gray-200 leading-relaxed">
                Explore daily celestial wonders and recent sky logs from fellow stargazers.
            </p>
        </div>

        {% if user.is_authenticated %}
        <div>
            <a href="{% url 'log_create' %}" class="inline-block bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-full transition duration-300 ease-in-out shadow-lg transform hover:scale-105">
                ‚ûï Create New Log
            </a>
        </div>
        {% endif %}

        <!-- NASA APOD -->
        <div class="bg-gray-800 rounded-xl shadow-lg p-8 border border-blue-700/30">
            <h2 class="text-3xl font-semibold mb-6 text-blue-400">üî≠ NASA Astronomy Picture of the Day</h2>
            {% if apod.url %}
                <h3 class="text-xl font-medium mb-3 text-gray-100">{{ apod.title }}</h3>
                <img src="{{ apod.url }}" alt="NASA APOD" class="rounded-lg max-h-96 w-full object-cover mb-4 shadow-md">
                <p class="text-gray-300 text-base leading-relaxed">{{ apod.explanation }}</p>
            {% else %}
                <p class="text-gray-400 text-lg">
                    NASA APOD data not available right now. Please check back later.
                </p>
            {% endif %}
        </div>

        <!-- Logs -->
        <div class="bg-gray-800 rounded-xl shadow-lg p-8 border border-blue-700/30">
            <h2 class="text-3xl font-semibold mb-6 text-blue-400">üìù Recent Celestial Logs</h2>
            {% if logs %}
                <div class="space-y-8">
                    {% for log in logs %}
                        <div class="bg-gray-700 p-6 rounded-lg shadow-md border border-gray-600 transition duration-300 ease-in-out hover:border-blue-500">
                            <h4 class="text-xl font-bold text-gray-100 mb-2">{{ log.title }}</h4>
                            <p class="text-gray-300 mb-3 leading-relaxed">{{ log.description|truncatewords:30 }}</p>
                            {% if log.photo %}
                                <img src="{{ log.photo.url }}" alt="Observation Photo" class="rounded-lg max-h-72 w-full object-cover mb-3 shadow-sm">
                            {% endif %}
                            <p class="text-sm text-gray-400">
                                Logged by <span class="text-blue-300 font-medium">{{ log.user.username }}</span> on {{ log.created_at|date:"F d, Y" }}
                            </p>
                        </div>
                    {% endfor %}
                </div>
            {% else %}
                <p class="text-gray-400 text-lg">
                    No logs yet. <a href="{% url 'log_create' %}" class="text-blue-400 underline hover:text-blue-300 transition duration-300">Be the first to add one!</a>
                </p>
            {% endif %}
        </div>
    </div>

    <!-- Empty Sidebar -->
    <div></div>
</div>

<!-- Fixed Chat Section -->
<div id="chat-container" class="fixed bottom-4 right-4 w-full max-w-sm sm:max-w-md max-h-[70vh] bg-gray-800 rounded-xl shadow-xl z-50 flex flex-col border border-blue-700/30">
    <!-- Header with Minimize Button -->
    <div class="flex justify-between items-center bg-gray-800 p-4 border-b border-gray-700 rounded-t-xl">
        <h3 class="text-lg font-semibold text-blue-400">üí¨ Live Comments</h3>
        <button id="chat-toggle" class="text-white hover:text-gray-400 text-xl focus:outline-none transition duration-300">‚àí</button>
    </div>

    <!-- Chat Content -->
    <div id="chat-body" class="flex-1 flex flex-col p-4 space-y-3 overflow-y-auto max-h-[60vh]">
        <div id="live-comments" class="flex-1 overflow-y-auto space-y-3 pr-1"></div>

        <form id="chat-form" class="mt-4 flex">
            <input type="text" id="chat-message-input" placeholder="Type a message..."
                class="flex-1 px-4 py-2 rounded-l-lg bg-gray-700 text-white border border-gray-600 focus:outline-none focus:ring-2 focus:ring-blue-500 break-words transition duration-300"
                autocomplete="off">
            <button type="submit"
                class="bg-blue-600 hover:bg-blue-700 text-white px-5 py-2 rounded-r-lg transition duration-300 ease-in-out shadow-md">Send</button>
        </form>
    </div>
</div>

<script>
    const commentBox = document.getElementById('live-comments');
    const chatInput = document.getElementById('chat-message-input');
    const chatForm = document.getElementById('chat-form');
    const chatBody = document.getElementById('chat-body');
    const toggleBtn = document.getElementById('chat-toggle');

    const wsScheme = window.location.protocol === "https:" ? "wss" : "ws";
    const socket = new WebSocket(wsScheme + '://' + window.location.host + '/ws/comments/');

    socket.onmessage = function (e) {
        const data = JSON.parse(e.data);
        if (data.message && data.username) {
            const comment = document.createElement('div');
            comment.innerHTML = `<strong class="text-blue-400">${data.username}</strong>: <span class="break-words">${data.message}</span>`;
            comment.className = "bg-blue-900 text-white p-2 rounded shadow-md whitespace-pre-wrap break-words";
            commentBox.appendChild(comment);
            commentBox.scrollTop = commentBox.scrollHeight;
        }
    };

    chatForm.addEventListener('submit', function (e) {
        e.preventDefault();
        const message = chatInput.value.trim();
        if (message) {
            socket.send(JSON.stringify({ message: message }));
            chatInput.value = '';
        }
    });

    toggleBtn.addEventListener('click', () => {
        if (chatBody.style.display === 'none') {
            chatBody.style.display = 'flex';
            toggleBtn.textContent = '‚àí';
        } else {
            chatBody.style.display = 'none';
            toggleBtn.textContent = '+';
        }
    });
</script>
{% endblock %}
